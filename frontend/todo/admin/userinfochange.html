<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .container {
            width: 60%;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .field {
            margin-bottom: 10px;
        }
        .field label {
            font-weight: bold;
        }
        .field span {
            margin-left: 10px;
        }
        select {
            padding: 5px;
        }
        button.save-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
        }
        button.save-btn:hover {
            background-color: #0b7dda;
        }
        button.back-btn {
            background-color: #777;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
        }
        button.back-btn:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <h1>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h1>

    <div class="container">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="field"><label>ID:</label> <span id="userId"></span></div>
        <div class="field"><label>Username:</label> <span id="username"></span></div>
        <div class="field"><label>Email:</label> <span id="email"></span></div>
        <div class="field"><label>Password (hash):</label> <span id="password"></span></div>
        <div class="field"><label>Roles:</label> <span id="roles"></span></div>

        <div class="field"><label>Taken Projects:</label> <span id="takenProjects"></span></div>
        <div class="field"><label>Created Projects:</label> <span id="createdProjects"></span></div>
        <div class="field"><label>Completed Projects:</label> <span id="completedProjects"></span></div>

        <hr>

        <!-- –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
        <label for="roleSelect">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å:</label>
        <select id="roleSelect">
            <option value="ROLE_ADMIN">ROLE_ADMIN</option>
            <option value="ROLE_USER">ROLE_USER</option>
            <option value="ROLE_COMPANY">ROLE_COMPANY</option>
        </select>

        <br>
        <button class="save-btn" onclick="updateRole()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–æ–ª—å</button>
        <button class="back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');

        // üëâ –§—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä –¥–µ–ª–∞–µ—Ç fetch –Ω–∞ /api/admin/users/{id}
        fetch(`/api/admin/users/${userId}`)
            .then(res => res.json())
            .then(user => {
                document.getElementById('userId').innerText = user.id;
                document.getElementById('username').innerText = user.username;
                document.getElementById('email').innerText = user.email;
                document.getElementById('password').innerText = user.password;
                document.getElementById('roles').innerText = user.roles.map(r => r.name).join(', ');

                document.getElementById('takenProjects').innerText = user.takenProjects.length;
                document.getElementById('createdProjects').innerText = user.createdProjects.length;
                document.getElementById('completedProjects').innerText = user.completedProjects.length;

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ä–æ–ª—å
                const currentRole = user.roles[0]?.name || '';
                document.getElementById('roleSelect').value = currentRole;
            });

        function updateRole() {
            const newRole = document.getElementById('roleSelect').value;

            // üëâ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–º–µ–Ω—ã —Ä–æ–ª–∏
            fetch(`/api/admin/users/${userId}/roles`, {
                method: 'POST', // –∏–ª–∏ PUT ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–µ–∫–µ–Ω–¥–∞
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ role: newRole }) // —Ñ–æ—Ä–º–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–µ–∫–µ–Ω–¥–∞
            })
            .then(res => {
                if (res.ok) {
                    alert('‚úÖ –†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏');
                }
            })
            .catch(err => {
                console.error(err);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            });
        }

        function goBack() {
            window.location.href = 'users.html'; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        }
    </script>
</body>
</html>